'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

exports.default = function ({ errorPath, defaultErrorMessage, showRealErrorMessage }) {

    return (() => {
        var _ref = (0, _asyncToGenerator3.default)(function* (err, req, res, next) {
            if (req.lavasIgnoreFlag) {
                return next();
            }

            console.log('[Lavas] error middleware catch error:');
            console.log(err);

            if (errorPath === req.url.replace(/\?.+$/, '')) {
                // if already in error procedure, then end this request immediately, avoid infinite loop
                res.end();
                return;
            }

            // redirect to the corresponding url
            let target = `${errorPath}?error=${encodeURIComponent(showRealErrorMessage ? err.message : defaultErrorMessage)}`;
            if (errorPath) {
                res.writeHead(302, { Location: target });
            }

            res.end();
        });

        return function (_x, _x2, _x3, _x4) {
            return _ref.apply(this, arguments);
        };
    })();
};

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

module.exports = exports['default']; /**
                                      * @file expressError.js, error handler middleware for express
                                      * @author lavas
                                      */
/* istanbul ignore file */

/**
 * generate error middleware
 *
 * @param {string} option.errPath errPath
 * @return {Function} koa middleware
 */