'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

exports.default = function (core) {
    return (() => {
        var _ref = (0, _asyncToGenerator3.default)(function* (req, res, next) {
            if (req.lavasIgnoreFlag) {
                return next();
            }

            let url = req.url;
            let errorHandler = function (err) {
                return next(err);
            };

            _logger2.default.info('route middleware', `ssr ${url}`);

            let { err, html } = yield core.renderer.render({
                url,
                req,
                res,
                error: errorHandler
            });

            if (err) {
                return next(err);
            }
            res.end(html);
        });

        return function (_x, _x2, _x3) {
            return _ref.apply(this, arguments);
        };
    })();
};

var _logger = require('../utils/logger');

var _logger2 = _interopRequireDefault(_logger);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @file ssrMiddlewareFactory.js
 * @author lavas
 */

module.exports = exports['default'];

/**
 * generate ssr middleware
 *
 * @param {Object} core lavas core
 * @return {Function} koa middleware
 */